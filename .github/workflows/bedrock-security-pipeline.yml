name: ğŸ›¡ï¸ Bedrock AI Security Analysis Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily security scan at 2 AM UTC
    - cron: '0 2 * * *'

env:
  AWS_REGION: us-east-1
  BEDROCK_AGENT_ID: ${{ secrets.BEDROCK_AGENT_ID }}
  BEDROCK_AGENT_ALIAS_ID: ${{ secrets.BEDROCK_AGENT_ALIAS_ID }}

jobs:
  # ğŸ” Security Analysis with Bedrock AI
  bedrock-security-analysis:
    name: ğŸ¤– AI-Powered Security Analysis
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule' || github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for better analysis
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd security && npm ci
          cd ../bedrock && npm ci
          
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: ğŸ›¡ï¸ Run Bedrock AI Security Analysis
        id: bedrock-analysis
        run: |
          echo "ğŸš€ Starting AI-powered security analysis..."
          node scripts/bedrock-security-pipeline.js \
            --repository="${{ github.repository }}" \
            --branch="${{ github.ref_name }}" \
            --commit="${{ github.sha }}" \
            --pr-number="${{ github.event.number }}" \
            --agent-id="${{ env.BEDROCK_AGENT_ID }}" \
            --alias-id="${{ env.BEDROCK_AGENT_ALIAS_ID }}" \
            --output="security-analysis-report.json"
            
      - name: ğŸ“Š Generate Security Report
        run: |
          echo "ğŸ“‹ Generating comprehensive security report..."
          node scripts/generate-security-report.js \
            --input="security-analysis-report.json" \
            --output="SECURITY-REPORT.md" \
            --format="markdown"
            
      - name: ğŸ“¤ Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-report-${{ github.run_number }}
          path: |
            security-analysis-report.json
            SECURITY-REPORT.md
          retention-days: 30
          
      - name: ğŸ’¬ Comment on Pull Request
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'SECURITY-REPORT.md';
            
            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');
              
              // Truncate report if too long (GitHub comment limit)
              const truncatedReport = report.length > 32000 
                ? report.substring(0, 32000) + '\n\n... (Report truncated due to length)'
                : report;
                
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ›¡ï¸ AI Security Analysis Report\n\n${truncatedReport}`
              });
            }
            
      - name: ğŸš¨ Security Gate Check
        id: security-gate
        run: |
          echo "ğŸ” Checking security gate criteria..."
          node scripts/security-gate-check.js \
            --report="security-analysis-report.json" \
            --max-critical="0" \
            --max-high="3" \
            --max-medium="10"
            
      - name: âŒ Fail on Critical Issues
        if: steps.security-gate.outputs.passed != 'true'
        run: |
          echo "âŒ Security gate failed! Critical security issues found."
          echo "Please review and fix security issues before merging."
          exit 1

  # ğŸ”„ Traditional Security Scans
  traditional-security-scans:
    name: ğŸ” Traditional Security Scans
    runs-on: ubuntu-latest
    needs: bedrock-security-analysis
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd security && npm ci
          
      - name: ğŸ” Run npm Audit
        run: |
          echo "ğŸ” Running npm security audit..."
          npm audit --audit-level=moderate --json > npm-audit-report.json || true
          
      - name: ğŸ›¡ï¸ Run ESLint Security Rules
        run: |
          echo "ğŸ›¡ï¸ Running ESLint security analysis..."
          npx eslint . --ext .js,.ts,.jsx,.tsx \
            --config .eslintrc.security.js \
            --format json \
            --output-file eslint-security-report.json || true
            
      - name: ğŸ”’ Run Snyk Security Scan
        if: env.SNYK_TOKEN != ''
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "ğŸ”’ Running Snyk security scan..."
          npm install -g snyk
          snyk test --json > snyk-report.json || true
          
      - name: ğŸ“Š Upload Security Scan Reports
        uses: actions/upload-artifact@v4
        with:
          name: traditional-security-scans-${{ github.run_number }}
          path: |
            npm-audit-report.json
            eslint-security-report.json
            snyk-report.json
          retention-days: 30

  # ğŸš€ Deployment Pipeline
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [bedrock-security-analysis, traditional-security-scans]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: ğŸ—ï¸ Deploy Infrastructure
        run: |
          echo "ğŸ—ï¸ Deploying infrastructure with Terraform..."
          cd infrastructure
          terraform init
          terraform plan -out=tfplan
          terraform apply -auto-approve tfplan
          
      - name: ğŸ³ Build and Push Docker Images
        run: |
          echo "ğŸ³ Building and pushing Docker images..."
          docker build -t ${{ secrets.ECR_REGISTRY }}/api:${{ github.sha }} ./microservices/api
          docker build -t ${{ secrets.ECR_REGISTRY }}/auth:${{ github.sha }} ./microservices/auth
          
          docker push ${{ secrets.ECR_REGISTRY }}/api:${{ github.sha }}
          docker push ${{ secrets.ECR_REGISTRY }}/auth:${{ github.sha }}
          
      - name: â˜¸ï¸ Deploy to Kubernetes
        run: |
          echo "â˜¸ï¸ Deploying to Kubernetes..."
          kubectl apply -f k8s/namespaces/
          kubectl apply -f k8s/configmaps/
          kubectl apply -f k8s/secrets/
          kubectl apply -f k8s/deployments/
          kubectl apply -f k8s/services/
          kubectl apply -f k8s/ingress/
          
      - name: ğŸ” Verify Deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          kubectl get pods -n devsecops
          kubectl get services -n devsecops
          kubectl get ingress -n devsecops
          
      - name: ğŸ“Š Deploy Monitoring
        run: |
          echo "ğŸ“Š Deploying monitoring stack..."
          kubectl apply -f monitoring/k8s/
          
      - name: ğŸ‰ Deployment Success Notification
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸš€ Application is now live in production!"
          echo "ğŸ“Š Monitoring dashboards available at: https://grafana.your-domain.com"

  # ğŸ“Š Security Dashboard Update
  update-security-dashboard:
    name: ğŸ“Š Update Security Dashboard
    runs-on: ubuntu-latest
    needs: [bedrock-security-analysis, traditional-security-scans]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“Š Download Security Reports
        uses: actions/download-artifact@v4
        with:
          name: security-analysis-report-${{ github.run_number }}
          path: ./reports
          
      - name: ğŸ“Š Download Traditional Scan Reports
        uses: actions/download-artifact@v4
        with:
          name: traditional-security-scans-${{ github.run_number }}
          path: ./reports
          
      - name: ğŸ“ˆ Update Grafana Dashboard
        run: |
          echo "ğŸ“ˆ Updating security dashboard..."
          node scripts/update-security-dashboard.js \
            --bedrock-report="./reports/security-analysis-report.json" \
            --npm-report="./reports/npm-audit-report.json" \
            --eslint-report="./reports/eslint-security-report.json" \
            --snyk-report="./reports/snyk-report.json"
            
      - name: ğŸ“§ Send Security Summary
        if: github.event_name == 'schedule'
        run: |
          echo "ğŸ“§ Sending daily security summary..."
          node scripts/send-security-summary.js \
            --reports="./reports" \
            --recipients="${{ secrets.SECURITY_TEAM_EMAIL }}"
